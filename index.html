<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NorthStar Logistics | Professional VTC</title>

    <style>
        /* RESET & BASE */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #0d1117;
            color: white;
            overflow-x: hidden;
            line-height: 1.6;
        }

        /* HEADER */
        header {
            position: fixed;
            top: 0;
            width: 100%;
            padding: 10px 40px;
            background-color: rgba(13, 17, 23, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 999;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .logo-area { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        header img { width: 45px; height: 45px; border-radius: 4px; object-fit: contain; }
        header h1 { font-size: 1.2rem; letter-spacing: 1px; text-transform: uppercase; color: #4a6a8c; font-weight: 800; }

        nav { display: flex; align-items: center; }
        nav a {
            color: #cfd8e3;
            margin-left: 20px;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.85rem;
            transition: color 0.3s;
            white-space: nowrap;
        }

        nav a:hover { color: #4a6a8c; }
        .portal-btn { background: #4a6a8c; padding: 8px 18px; border-radius: 20px; color: white !important; }

        /* VIEW TOGGLE */
        .page-view { display: none; min-height: 100vh; padding-top: 70px; }
        .page-view.active { display: block; }

        /* HERO SECTIONS */
        .hero {
            height: 60vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
            padding: 0 20px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease-in-out;
        }

        .hero::before {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, rgba(13, 17, 23, 0.4), rgba(13, 17, 23, 1));
            z-index: 1;
        }

        .hero > * { position: relative; z-index: 2; }
        .hero-title { font-size: 3.5rem; font-weight: 800; margin-bottom: 10px; }
        .hero-sub { font-size: 1.1rem; color: #8b9eb3; max-width: 700px; }

        /* RESPONSIVE GRID HELPERS */
        .responsive-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 20px;
        }

        /* RECRUITMENT MODAL */
        .recruit-modal {
            position: fixed; inset: 0; 
            background: rgba(0, 0, 0, 0.85);
            display: none; justify-content: center; align-items: center; z-index: 2000;
            backdrop-filter: blur(8px);
            padding: 20px;
        }
        
        .recruit-content {
            background: linear-gradient(135deg, rgba(16, 20, 26, 0.95), rgba(13, 17, 23, 0.98));
            padding: 30px;
            border-radius: 4px;
            width: 100%;
            max-width: 550px;
            text-align: center;
            border: 1px solid rgba(74, 166, 140, 0.3);
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.8), 0 0 10px rgba(74, 166, 140, 0.2);
            position: relative;
            overflow: hidden;
            clip-path: polygon(0 0, 100% 0, 100% 90%, 95% 100%, 0 100%);
        }

        /* Scanning Animation */
        .recruit-content::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 2px;
            background: linear-gradient(90deg, transparent, #4a6a8c, #00f2ff, #4a6a8c, transparent);
            animation: scan-line 3s linear infinite;
            z-index: 10;
            opacity: 0.8;
            box-shadow: 0 0 15px #00f2ff;
            pointer-events: none;
        }

        @keyframes scan-line {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .recruit-image {
            width: 100%;
            height: 150px; /* Constrain height to keep modal tidy */
            object-fit: contain;
            border-radius: 2px;
            margin-bottom: 20px;
            border: 1px solid rgba(74, 166, 140, 0.3);
            filter: brightness(0.9) contrast(1.1);
            background: rgba(0,0,0,0.3); /* Dark background for logo visibility */
            padding: 10px;
        }

        .recruit-content h3 {
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 1px solid rgba(74, 166, 140, 0.3);
            margin-bottom: 20px;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recruit-content h3::after {
            content: 'TERMINAL_ACTIVE';
            font-size: 0.6rem;
            background: rgba(74, 166, 140, 0.1);
            color: #4a6a8c;
            padding: 2px 6px;
            border: 1px solid rgba(74, 166, 140, 0.3);
        }

        .join-btn-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .join-option {
            background: rgba(13, 17, 23, 0.5);
            padding: 15px;
            border-radius: 2px;
            text-decoration: none;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: 0.3s;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            position: relative;
        }

        .join-option:hover { 
            background: rgba(74, 166, 140, 0.1); 
            border-color: #00f2ff; 
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.2);
            transform: translateY(-2px);
        }

        .join-option.disabled {
            opacity: 1;
            background: rgba(243, 156, 18, 0.05);
            border: 1px solid rgba(243, 156, 18, 0.4);
            cursor: not-allowed;
            animation: amber-pulse 2s infinite alternate;
        }
        
        .join-option.disabled strong { color: #f39c12; text-shadow: 0 0 5px rgba(243, 156, 18, 0.4); }
        .join-option.disabled span { color: rgba(255,255,255,0.6); font-size: 0.8rem; }

        .join-option.disabled::after {
            content: 'COMING SOON!';
            position: absolute;
            top: 5px; right: 5px;
            font-size: 0.5rem;
            color: #f39c12;
            border: 1px solid #f39c12;
            padding: 1px 3px;
        }

        @keyframes amber-pulse {
            from { box-shadow: 0 0 5px rgba(243, 156, 18, 0.1); border-color: rgba(243, 156, 18, 0.3); }
            to { box-shadow: 0 0 15px rgba(243, 156, 18, 0.3); border-color: rgba(243, 156, 18, 0.8); }
        }

        /* CONTENT CONTAINERS */
        .content-section { max-width: 1000px; margin: -40px auto 60px; padding: 0 20px; position: relative; z-index: 5; }
        .card {
            background: #161b22;
            border-radius: 12px;
            padding: 40px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 40px; }
        .feature-item { background: #0d1117; padding: 25px; border-radius: 10px; border: 1px solid #30363d; }
        .feature-item h3 { color: #4a6a8c; margin-bottom: 10px; }

        .partner-img { width: 100%; height: 100px; object-fit: contain; margin-bottom: 15px; background: #1c2128; border-radius: 8px; padding: 10px; }

        .login-box {
            background: #161b22;
            max-width: 400px;
            margin: 40px auto;
            padding: 40px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 0.8rem; color: #8b9eb3; }
        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 12px;
            border-radius: 6px;
            background: #0d1117;
            border: 1px solid #30363d;
            color: white;
            font-family: inherit;
        }

        /* DASHBOARD ELEMENTS */
        .dashboard-layout { display: flex; min-height: calc(100vh - 70px); }
        .sidebar { width: 240px; background: #0d1117; border-right: 1px solid #30363d; padding: 20px; }
        
        .sidebar-btn {
            display: flex;
            align-items: center; /* Vertically center icon and text */
            justify-content: flex-start; /* Align left */
            gap: 15px; /* Space between icon and text */
            width: 100%;
            padding: 12px 15px;
            text-align: left;
            background: none;
            border: none;
            color: #8b9eb3;
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 5px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .sidebar-btn.active { background: #4a6a8c; color: white; }
        .sidebar-btn:hover:not(.active) { background: rgba(255, 255, 255, 0.05); color: white; }
        
        .sidebar-btn .icon { font-size: 1.1rem; width: 20px; text-align: center; }

        .sidebar-badge {
            background: #e74c3c;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
            margin-left: auto; /* Push badge to the right */
        }

        .main-dash { flex: 1; padding: 40px; background: #0d1117; overflow-y: auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .data-table { width: 100%; border-collapse: collapse; margin-top: 0; font-size: 0.9rem; min-width: 600px; }
        .data-table th { text-align: left; padding: 12px; border-bottom: 2px solid #30363d; color: #4a6a8c; }
        .data-table td { padding: 12px; border-bottom: 1px solid #30363d; }

        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .badge-pending { background: #f39c12; color: white; }
        .badge-approved { background: #27ae60; color: white; }
        .badge-denied { background: #c0392b; color: white; }

        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: #4a6a8c; color: white; }
        .btn-danger { background: #c0392b; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }

        .tips-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .tip-box { background: #1c2128; border: 1px solid #30363d; padding: 15px; border-radius: 8px; text-align: center; transition: 0.3s; }

        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-body { background: #161b22; padding: 30px; border-radius: 12px; width: 440px; text-align: center; border: 1px solid rgba(255,255,255,0.1); max-width: 90%; }
        .action-modal { background: #161b22; padding: 30px; border-radius: 12px; width: 440px; text-align: left; }

        footer { padding: 40px; text-align: center; color: #484f58; font-size: 0.8rem; border-top: 1px solid #30363d; }

        .welcome-banner { background: #1c2128; padding: 20px; border-radius: 8px; border-left: 4px solid #4a6a8c; margin-bottom: 20px; }
        
        .forgot-link { display: block; margin-top: 15px; text-align: center; font-size: 0.85rem; color: #8b9eb3; text-decoration: none; cursor: pointer; }

        .insight-card { border-left: 3px solid #4a6a8c; background: #0d1117; padding: 20px; border-radius: 0 8px 8px 0; margin-bottom: 20px; }
        .insight-card ul { list-style: none; padding-left: 5px; }
        .insight-card li { margin-bottom: 8px; color: #cfd8e3; font-size: 0.9rem; display: flex; align-items: flex-start; gap: 10px; }
        .insight-card li::before { content: "‚Ä¢"; color: #4a6a8c; font-weight: bold; }

        /* BULLETIN BOARD STYLES */
        .bulletin-card {
            background: linear-gradient(135deg, rgba(28, 33, 40, 0.95), rgba(13, 17, 23, 0.98));
            border-left: 4px solid #4a6a8c;
            border-radius: 0 8px 8px 0;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border-top: 1px solid rgba(255,255,255,0.05);
            border-right: 1px solid rgba(255,255,255,0.05);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.2s;
        }
        .bulletin-card:hover { transform: translateX(5px); }
        .bulletin-title { font-size: 1.1rem; color: white; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .bulletin-body { font-size: 0.9rem; color: #cfd8e3; line-height: 1.6; }
        .bulletin-tag {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: bold;
            margin-left: auto;
            letter-spacing: 0.5px;
        }
        
        .bulletin-divider {
            border: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #4a6a8c, transparent);
            margin: 15px 0;
            opacity: 0.6;
        }
        
        /* Rich Text Styles for Bulletins */
        .bulletin-body strong { color: #fff; font-weight: 800; }
        .bulletin-body em { color: #8b9eb3; font-style: italic; }
        .bulletin-body ul { margin-left: 20px; margin-bottom: 10px; }
        .bulletin-body li { margin-bottom: 4px; }
        
        .toolbar-btn {
            background: #21262d; border: 1px solid #30363d; color: #8b9eb3;
            padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-right: 4px;
            font-size: 0.8rem; font-weight: bold;
        }
        .toolbar-btn:hover { background: #30363d; color: white; }

        /* QUICK ACCESS GRID (UPDATED) */
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .quick-btn {
            background: linear-gradient(145deg, #1c2128, #161b22);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 15px 20px;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            display: flex;
            flex-direction: row; /* Icon Left */
            align-items: center;
            justify-content: flex-start;
            gap: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: left;
        }
        
        .quick-btn:hover {
            transform: translateY(-5px);
            border-color: #4a6a8c;
            background: linear-gradient(145deg, #21262d, #1c2128);
            box-shadow: 0 8px 15px rgba(0,0,0,0.3);
        }
        
        .quick-icon {
            font-size: 1.5rem;
            margin-bottom: 0;
        }
        
        .quick-label {
            font-size: 0.95rem;
            font-weight: 600;
            color: #cfd8e3;
        }

        /* --- HOME VIEW CLEANUP --- */
        #homeView .content-section {
            margin-top: 40px; /* Spaced out from hero */
            max-width: 1200px;
        }

        #homeView .card {
            background: transparent; /* Remove heavy card background */
            border: none;
            box-shadow: none;
            padding: 0;
            margin-bottom: 80px;
        }

        .home-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }

        .home-feature-item {
            background: rgba(22, 27, 34, 0.6);
            backdrop-filter: blur(5px);
            padding: 40px 30px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            text-align: center;
            transition: transform 0.3s ease, border-color 0.3s ease, background-color 0.3s ease;
        }

        .home-feature-item:hover {
            transform: translateY(-8px);
            border-color: #4a6a8c;
            background: rgba(22, 27, 34, 0.9);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .home-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            display: block;
        }

        .home-title {
            font-size: 2.2rem;
            text-align: center;
            margin-bottom: 30px;
            font-weight: 700;
            color: white;
            position: relative;
            display: inline-block;
            left: 50%;
            transform: translateX(-50%);
        }

        .home-title::after {
            content: '';
            display: block;
            width: 60px;
            height: 4px;
            background: #4a6a8c;
            margin: 10px auto 0;
            border-radius: 2px;
        }

        /* Override feature item style within home view for consistency */
        #homeView .feature-item {
            background: rgba(22, 27, 34, 0.6);
            backdrop-filter: blur(5px);
            padding: 30px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.3s ease;
        }
        #homeView .feature-item:hover {
            transform: translateY(-5px);
            border-color: #4a6a8c;
        }

        /* --- CONVOY CARDS --- */
        .convoy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .convoy-card {
            background: #1c2128;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            flex-direction: column;
        }

        .convoy-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border-color: #4a6a8c;
        }

        .convoy-header {
            height: 120px;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .convoy-header::before {
            content: '';
            position: absolute; inset:0;
            background: linear-gradient(to bottom, transparent, #1c2128);
        }

        .convoy-date-box {
            position: absolute;
            top: 15px; left: 15px;
            background: rgba(13, 17, 23, 0.9);
            border: 1px solid #4a6a8c;
            border-radius: 8px;
            padding: 5px 12px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .convoy-game-badge {
            position: absolute;
            top: 15px; right: 15px;
            padding: 5px 10px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .convoy-day { font-size: 1.4rem; font-weight: 800; color: #fff; line-height: 1; }
        .convoy-month { font-size: 0.7rem; text-transform: uppercase; color: #4a6a8c; font-weight: bold; }

        .convoy-body { padding: 20px; flex: 1; display: flex; flex-direction: column; }
        
        .convoy-title { font-size: 1.2rem; font-weight: bold; color: white; margin-bottom: 10px; }
        
        .convoy-meta {
            display: flex; align-items: center; gap: 10px;
            font-size: 0.85rem; color: #8b9eb3; margin-bottom: 5px;
        }
        
        .convoy-meta span { display: flex; align-items: center; gap: 5px; }

        .convoy-route-vis {
            margin: 15px 0;
            padding: 10px;
            background: rgba(13, 17, 23, 0.5);
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .route-arrow { color: #4a6a8c; font-weight: bold; }

        /* --- MEDIA GRID --- */
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .media-card {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: #161b22;
            transition: transform 0.3s;
            aspect-ratio: 16/9;
        }
        
        .media-card:hover { transform: scale(1.02); z-index: 10; border-color: #4a6a8c; }

        .media-img {
            width: 100%; height: 100%;
            object-fit: cover;
            display: block;
        }

        .media-overlay {
            position: absolute; inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            opacity: 0; transition: opacity 0.3s;
            display: flex; align-items: flex-end; padding: 20px;
        }

        .media-card:hover .media-overlay { opacity: 1; }

        .media-title { font-weight: bold; color: white; font-size: 1.1rem; }

        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 768px) {
            header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }

            .logo-area {
                width: 100%;
                justify-content: center;
            }

            nav {
                width: 100%;
                overflow-x: auto;
                white-space: nowrap;
                justify-content: flex-start;
                padding-bottom: 5px; /* Scrollbar space */
            }

            nav a {
                margin-left: 0;
                margin-right: 20px;
                font-size: 0.9rem;
                padding: 5px 0;
            }

            .hero { height: 50vh; }
            .hero-title { font-size: 2rem; }
            
            .content-section { margin-top: 0; }
            .card { padding: 20px; }

            /* Collapse Grids */
            .responsive-grid,
            .join-btn-container,
            .tips-grid {
                grid-template-columns: 1fr !important;
            }
            
            /* Quick actions grid for mobile */
            .quick-actions-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            /* Dashboard Layout */
            .dashboard-layout {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #30363d;
                padding: 10px;
                display: flex;
                overflow-x: auto;
                white-space: nowrap;
                gap: 10px;
            }

            .sidebar h2, .sidebar hr { display: none; }
            
            .sidebar-btn {
                width: auto;
                margin-bottom: 0;
                background: rgba(255,255,255,0.05);
                border-radius: 20px;
                justify-content: center;
                white-space: nowrap;
                flex-shrink: 0;
            }
            .sidebar-btn.active { background: #4a6a8c; }

            .main-dash { padding: 20px; }

            /* Fix recruit modal on mobile */
            .recruit-content {
                clip-path: none; 
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>

<!-- MODALS -->
<div id="generalModal" class="modal">
    <div class="modal-body">
        <h3 id="modalTitle">Notice</h3>
        <div id="modalContentArea" style="margin: 20px 0; text-align: left;">
            <p id="modalText" style="color: #cfd8e3; white-space: pre-line; line-height: 1.8;"></p>
        </div>
        <button onclick="closeModal()" class="btn btn-primary" style="width: 100%;">Close</button>
    </div>
</div>

<!-- ACTION MODAL FOR LOA/REPORTS -->
<div id="actionModal" class="modal">
    <div class="modal-body action-modal">
        <h3 id="actionModalTitle">Process Request</h3>
        <p id="actionModalText" style="margin: 10px 0; font-size: 0.9rem; color: #8b9eb3;"></p>
        <div class="input-group">
            <label>Staff Comment / Reason</label>
            <textarea id="actionReasonInput" rows="3" placeholder="Enter reason for this decision..."></textarea>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button id="actionConfirmBtn" class="btn btn-success" style="flex:1;">Confirm</button>
            <button onclick="closeActionModal()" class="btn" style="flex:1; background:#444; color:white;">Cancel</button>
        </div>
    </div>
</div>

<!-- FORGOT PASSWORD MODAL -->
<div id="forgotPasswordModal" class="modal">
    <div class="modal-body action-modal">
        <h3>Account Access Request</h3>
        <p style="margin: 10px 0; font-size: 0.85rem; color: #8b9eb3;">Having trouble signing in? Submit your details and our management team will assist you.</p>
        
        <div class="input-group">
            <label>The Drivername (ID)</label>
            <input type="text" id="forgotDriverId" placeholder="e.g. Driver_123">
        </div>
        <div class="input-group">
            <label>Your Discord User</label>
            <input type="text" id="forgotDiscord" placeholder="e.g. user#1234">
        </div>
        <div class="input-group">
            <label>What do you want to change it to?</label>
            <input type="password" id="forgotNewPass" placeholder="Enter requested access key">
        </div>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="submitForgotPassword()" class="btn btn-primary" style="flex:1;">Send Request</button>
            <button onclick="closeForgotModal()" class="btn" style="flex:1; background:#444; color:white;">Cancel</button>
        </div>
    </div>
</div>

<!-- HEADER -->
<header id="mainHeader">
    <div class="logo-area" onclick="showView('home')">
        <img src="NSL_CLEAR_NO_TEXT.jpg" alt="NSL" onerror="this.style.display='none'">
        <h1>NorthStar</h1>
    </div>
    <nav>
        <a onclick="showView('home')">Home</a>
        <a onclick="showView('company')">About us</a>
        <a onclick="showView('partnership')">Partnerships</a>
        <a onclick="showView('convoy')">Convoys</a>
        <a onclick="showView('media')">Media</a>
        <a onclick="showView('report')">Report a Driver</a>
        <a onclick="showView('login')" class="portal-btn">Driver Portal</a>
    </nav>
</header>

<!-- HOME VIEW (CLEANED UP) -->
<div id="homeView" class="page-view active">
    <section class="hero" id="homeHero">
        <h1 class="hero-title">NorthStar Logistics</h1>
        <p class="hero-sub">Leading the way in virtual simulation transport. We provide a professional, friendly, and realistic driving environment for enthusiasts worldwide.</p>
        <div style="margin-top: 25px;">
            <button class="btn btn-primary" onclick="showJoinInstructions()">Join Our Fleet</button>
        </div>
    </section>
    
    <div class="content-section">
        <!-- FEATURES SECTION -->
        <div class="card">
            <h2 class="home-title">Why Drive With Us?</h2>
            <div class="home-features">
                <div class="home-feature-item">
                    <span class="home-icon">üëî</span>
                    <h3>Professionalism</h3>
                    <p style="color: #8b9eb3; font-size: 0.9rem; margin-top: 10px;">We take our operations seriously while maintaining a fun atmosphere for all drivers.</p>
                </div>
                <div class="home-feature-item">
                    <span class="home-icon">ü§ù</span>
                    <h3>Community</h3>
                    <p style="color: #8b9eb3; font-size: 0.9rem; margin-top: 10px;">Join a group of like-minded individuals who share a passion for the open road.</p>
                </div>
                <div class="home-feature-item">
                    <span class="home-icon">üìà</span>
                    <h3>Growth</h3>
                    <p style="color: #8b9eb3; font-size: 0.9rem; margin-top: 10px;">Rank up through our driver levels and take on more challenging specialized hauls.</p>
                </div>
                <div class="home-feature-item">
                    <span class="home-icon">üöÄ</span>
                    <h3>You</h3>
                    <p style="color: #8b9eb3; font-size: 0.9rem; margin-top: 10px;">We need you to help us grow. Join our staff team or drive to help us expand.</p>
                </div>
            </div>
        </div>

        <!-- TESTIMONIALS SECTION -->
        <div class="card">
            <h2 class="home-title">What Our Drivers Say</h2>
            <div id="publicTestimonials" class="home-features">
                <!-- Dynamically populated from Javascript -->
            </div>
        </div>
    </div>
</div>

<!-- COMPANY INFO VIEW (EXPANDED) -->
<div id="companyView" class="page-view">
    <section class="hero" id="companyHero">
        <h1 class="hero-title">Our Organization</h1>
        <p class="hero-sub">Founded on the principles of integrity and safety.</p>
    </section>
    <div class="content-section">
        <div class="card" style="background: #161b22; border: 1px solid rgba(255,255,255,0.05);">
            <h2 style="text-align: center; margin-bottom: 30px;">Who We Are</h2>
            
            <div style="margin-bottom: 30px; text-align: left; color: #cfd8e3; font-size: 0.95rem; line-height: 1.8;">
                <p style="margin-bottom: 15px;">
                    NorthStar Logistics was established in 2025 by a dedicated team of simulation enthusiasts. What began as a small convoy of friends exploring the virtual roads of Europe and America has evolved into a premier Virtual Trucking Company (VTC) known for its professionalism and welcoming community.
                </p>
                <p style="margin-bottom: 15px;">
                    We operate primarily within <strong>Euro Truck Simulator 2</strong> and <strong>American Truck Simulator</strong>, coordinating complex logistics operations, large-scale convoys, and competitive events. Our drivers are the heart of our organization, representing us on the virtual highways with skill and courtesy.
                </p>
                <p>
                    Whether you are a casual driver looking for a relaxing evening haul or a hardcore simulation expert aiming for the top of the leaderboards, NorthStar provides the infrastructure, dispatch systems, and community support to enhance your experience. We value <strong>integrity</strong>, <strong>safety</strong>, and most importantly, having <strong>fun</strong> together.
                </p>
            </div>

            <div style="border-top: 1px solid rgba(255,255,255,0.1); margin: 30px 0;"></div>

            <h3 style="text-align: center; margin-bottom: 20px; color: #4a6a8c;">Live Statistics</h3>
            <div class="responsive-grid">
                <div class="feature-item" style="text-align: center;">
                    <span style="font-size: 2rem; display: block; margin-bottom: 10px;">üöõ</span>
                    <h4 style="color:#4a6a8c">Active Drivers</h4>
                    <h2 id="dispDrivers" style="font-size: 2.5rem;">0</h2>
                </div>
                <div class="feature-item" style="text-align: center;">
                    <span style="font-size: 2rem; display: block; margin-bottom: 10px;">üì¶</span>
                    <h4 style="color:#4a6a8c">Jobs Completed</h4>
                    <h2 id="dispJobs" style="font-size: 2.5rem;">0</h2>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PARTNERSHIP VIEW -->
<div id="partnershipView" class="page-view">
    <section class="hero" id="partnerHero">
        <h1 class="hero-title">Our Partners</h1>
        <p class="hero-sub">Collaborating with the best in the VTC industry to help others.</p>
    </section>
    <div class="content-section">
        <div class="card" style="background: #161b22; border: 1px solid rgba(255,255,255,0.05);">
            <h2 style="margin-bottom: 20px;">Affiliated Companies</h2>
            <div id="publicPartnerGrid" class="feature-grid">
                <!-- Dynamically populated -->
            </div>
        </div>
    </div>
</div>

<!-- CONVOY VIEW -->
<div id="convoyView" class="page-view">
    <section class="hero" id="convoyHero" style="background-image: url('https://images.unsplash.com/photo-1605218427306-0396d812068d?auto=format&fit=crop&q=80&w=2000');">
        <h1 class="hero-title">Event Convoys</h1>
        <p class="hero-sub">Join us on the open road. Check our schedule for official company convoys and events.</p>
    </section>
    
    <div class="content-section">
        <div id="publicConvoyGrid" class="convoy-grid">
            <!-- Dynamically populated by JS -->
        </div>
    </div>
</div>

<!-- MEDIA VIEW -->
<div id="mediaView" class="page-view">
    <section class="hero" id="mediaHero">
        <h1 class="hero-title">Company Media</h1>
        <p class="hero-sub">A glimpse into our journey. Screenshots from our fleet in action.</p>
    </section>
    
    <div class="content-section">
        <div id="publicMediaGrid" class="media-grid">
            <!-- Dynamically populated -->
        </div>
    </div>
</div>

<!-- REPORT A DRIVER VIEW -->
<div id="reportView" class="page-view">
    <section class="hero" id="reportHero">
        <h1 class="hero-title">Public Reporting</h1>
        <p class="hero-sub">Help us maintain our professional standards. Submit reports for reckless driving or misused tags, livery.</p>
    </section>
    <div class="content-section">
        <div class="card" style="background: #161b22; border: 1px solid rgba(255,255,255,0.05);">
            <h2>Driver Conduct Report</h2>
            <p style="margin: 10px 0 25px; color: #8b9eb3; font-size: 0.9rem;">Please provide as much detail as possible. False reports may lead to a permanent ban from our community servers.</p>
            
            <div class="responsive-grid">
                <div class="input-group">
                    <label>Driver ID / Name</label>
                    <input type="text" id="repDriverId" placeholder="Who are you reporting?">
                </div>
                <div class="input-group">
                    <label>Date & Time of Incident</label>
                    <input type="datetime-local" id="repDateTime">
                </div>
            </div>
            
            <div class="responsive-grid">
                <div class="input-group">
                    <label>Type of Incident</label>
                    <select id="repReason">
                        <option>Reckless Driving</option>
                        <option>Ramming / Trolling</option>
                        <option>Verbal Harassment</option>
                        <option>VTC Rule Violation</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Evidence Link (Video/Screenshot)</label>
                    <input type="text" id="repEvidence" placeholder="https://youtube.com/... or Imgur link">
                </div>
            </div>

            <div class="input-group">
                <label>Description of Incident</label>
                <textarea id="repDesc" rows="4" placeholder="Explain what happened..."></textarea>
            </div>
            <div class="input-group">
                <label>Your Contact Info (Optional)</label>
                <input type="text" id="repContact" placeholder="Your Discord or Email">
            </div>
            <button class="btn btn-danger" style="width:100%; padding: 15px;" onclick="submitPublicReport()">Submit Official Report</button>
        </div>
    </div>
</div>

<!-- LOGIN VIEW -->
<div id="loginView" class="page-view">
    <div class="login-box">
        <h2 style="text-align:center; margin-bottom:20px;">Staff / Driver Login</h2>
        <form id="authForm" onsubmit="handleLogin(event)">
            <div class="input-group">
                <label>Email Address</label>
                <input type="email" id="emailInput" placeholder="name@example.com" required>
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="passInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">Sign In</button>
            <div style="text-align:center; margin-top:15px; font-size:0.85rem;">
                <a class="forgot-link" onclick="handleSignUp()">No account? Sign Up</a>
            </div>
        </form>
    </div>
</div>

<!-- DRIVER DASHBOARD -->
<div id="driverPanelView" class="page-view" style="padding-top:0;">
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div style="margin-bottom: 20px;">
                <h2 style="font-size: 1rem; color: #4a6a8c; margin-bottom: 5px;">DRIVER HUB</h2>
                <div id="sidebarDriverRank" style="font-size: 0.7rem; color: #8b9eb3; text-transform: uppercase; letter-spacing: 1px;">Rank: Trainee</div>
            </div>
            <!-- Updated Sidebar Buttons with Icons -->
            <button class="sidebar-btn active" id="btnDDash" onclick="switchTab('driver', 'dash')">
                <span class="icon">üè†</span> Dashboard
            </button>
            <button class="sidebar-btn" id="btnDLog" onclick="switchTab('driver', 'log')">
                <span class="icon">üì¶</span> Submit Log
            </button>
            <button class="sidebar-btn" id="btnDInsights" onclick="switchTab('driver', 'insights')">
                <span class="icon">üí°</span> Insights
            </button>
            <button class="sidebar-btn" id="btnDLoa" onclick="switchTab('driver', 'loa')">
                <span class="icon">üìÖ</span> Request LOA
            </button>
            <button class="sidebar-btn" id="btnDHistory" onclick="switchTab('driver', 'history')">
                <span class="icon">üìú</span> History
            </button>
            <button class="sidebar-btn" id="btnDFeedback" onclick="switchTab('driver', 'feedback')">
                <span class="icon">üí¨</span> Feedback
            </button>
            <button class="sidebar-btn" id="btnDStreamer" onclick="switchTab('driver', 'streamer')" style="display:none;">
                <span class="icon">üé•</span> Request Streamer
            </button>
            <hr style="border:0; border-top:1px solid #30363d; margin: 20px 0;">
            <button class="sidebar-btn" style="color:#e74c3c" onclick="logout()">
                <span class="icon">üö™</span> Logout
            </button>
        </aside>
        <main class="main-dash">
            <div class="welcome-banner">
                <h2 id="driverWelcomeMsg">Welcome, Driver</h2>
                <p style="color: #8b9eb3; font-size: 0.9rem;">Personnel Portal | NorthStar Fleet Systems</p>
            </div>

            <!-- DASHBOARD TAB (HOME) -->
            <div id="tabDDash" class="tab-content active">
                <!-- RANK PROGRESS BAR SECTION -->
                <div class="card" style="margin-bottom: 20px; background: #161b22; border: 1px solid rgba(255,255,255,0.05); padding: 25px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:flex-end;">
                        <div>
                            <h4 style="color:#4a6a8c; margin-bottom: 2px;">Career Progress</h4>
                            <div style="font-size:0.8rem; color:#8b9eb3;">Next Promotion: <strong id="nextRankName" style="color:white">Junior Driver</strong></div>
                        </div>
                        <span id="rankProgressText" style="font-size:1.1rem; font-weight:bold; color:white;">0 / 5 Jobs</span>
                    </div>
                    <div style="background:#0d1117; height:12px; border-radius:6px; overflow:hidden; border: 1px solid #30363d;">
                        <div id="rankProgressBar" style="width:0%; height:100%; background: linear-gradient(90deg, #4a6a8c, #00f2ff); transition: width 1s ease-in-out; box-shadow: 0 0 10px rgba(0, 242, 255, 0.3);"></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:0.7rem; color:#484f58;">
                        <span>Current Rank</span>
                        <span>Target</span>
                    </div>
                </div>

                <!-- QUICK ACTIONS SECTION (UPDATED LAYOUT) -->
                <h3 style="margin-bottom: 15px; color: #4a6a8c; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px;">Quick Actions</h3>
                <div class="quick-actions-grid">
                    <button onclick="switchTab('driver', 'log')" class="quick-btn">
                        <span class="quick-icon">üì¶</span>
                        <span class="quick-label">Log Delivery</span>
                    </button>
                    <button onclick="switchTab('driver', 'loa')" class="quick-btn">
                        <span class="quick-icon">üìÖ</span>
                        <span class="quick-label">Request LOA</span>
                    </button>
                    <button onclick="switchTab('driver', 'insights')" class="quick-btn">
                        <span class="quick-icon">üí°</span>
                        <span class="quick-label">Safety Insights</span>
                    </button>
                    <button onclick="switchTab('driver', 'feedback')" class="quick-btn">
                        <span class="quick-icon">üí¨</span>
                        <span class="quick-label">Feedback</span>
                    </button>
                </div>

                <div class="tips-grid">
                    <div class="tip-box">
                        <h5>Pro Tip #1</h5>
                        <p>Don't drive 100. Physics always wins.</p>
                    </div>
                    <div class="tip-box">
                        <h5>Pro Tip #2</h5>
                        <p>Keep an eye out for lights. Red means stop, not floor it.</p>
                    </div>
                    <div class="tip-box">
                        <h5>Pro Tip #3</h5>
                        <p>Watch out for that tree. It's harder than your bumper.</p>
                    </div>
                </div>

                <div style="margin-top:30px;">
                    <div class="card" style="background: #161b22; border: 1px solid rgba(255,255,255,0.05);">
                        <h3 style="margin-bottom:15px; color:#4a6a8c">Live Fleet Bulletin</h3>
                        <div id="driverBulletinBoard">
                            <!-- Bulletins will render here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- SUBMIT LOG TAB -->
            <div id="tabDLog" class="tab-content">
                <h2>New Delivery Job</h2>
                <div class="card" style="margin-top: 20px; background: #161b22; border: 1px solid rgba(255,255,255,0.05);">
                    <div class="responsive-grid">
                        <div class="input-group">
                            <label>Game Simulator</label>
                            <select id="jobGame">
                                <option>ETS 2</option>
                                <option>ATS</option>
                            </select>
                        </div>
                        <div class="input-group"><label>Source City</label><input type="text" id="jobStart" placeholder="City, Country"></div>
                        <div class="input-group"><label>Destination</label><input type="text" id="jobEnd" placeholder="City, Country"></div>
                        <div class="input-group"><label>Cargo Type</label><input type="text" id="jobCargo" placeholder="e.g. Medical Supplies"></div>
                        <div class="input-group"><label>Job Time (Hrs)</label><input type="number" id="jobTime" step="0.1" placeholder="0.0"></div>
                        <div class="input-group"><label>Income</label><input type="number" id="jobIncome" placeholder="e.g. 15000"></div>
                    </div>
                    <button class="btn btn-success" style="width:100%; margin-top: 10px;" onclick="submitJob()">Log Delivery</button>
                </div>
            </div>

            <!-- SAFETY INSIGHTS TAB -->
            <div id="tabDInsights" class="tab-content">
                <h2>Safety Insights & Driver Handbook</h2>
                <p style="color: #8b9eb3; margin-bottom: 25px;">Essential protocols for NorthStar Logistics personnel.</p>
                
                <div class="insight-card">
                    <h4>Pre-Trip Inspection Checklist</h4>
                    <ul>
                        <li>Verify you got your truck and trailer befor starting a job.</li>
                        <li>Ensure all lights (headlights, signals, brake lights) are operational and is not blocked.</li>
                        <li>Check fluid levels: Diesel And Fluid (REQ).</li>
                        <li>Secure your truck and trailer.</li>
                    </ul>
                </div>

                <div class="insight-card">
                    <h4>Safe Driving Protocols</h4>
                    <ul>
                        <li>Maintain a 4-second following distance in clear conditions.</li>
                        <li>Observe all regional speed limits; company maximum is 90km/h (56mph).</li>
                        <li>Use indicators at least 4 seconds before initiating any lane change.</li>
                        <li>Dim high beams when within 500ft of oncoming traffic.</li>
                    </ul>
                </div>

                <div class="insight-card">
                    <h4>Adverse Weather Procedures</h4>
                    <ul>
                        <li><strong>Heavy Rain/Fog:</strong> Reduce speed by 10% and increase following distance to 8 seconds.</li>
                        <li><strong>Snow/Ice:</strong> Avoid sudden braking; use engine braking (Jake brakes) cautiously to prevent jackknifing.</li>
                        <li>If visibility drops below 20 meters, Pull over when you can and wait it out (Safety is the main thing).</li>
                    </ul>
                </div>

                <div class="insight-card">
                    <h4>Incident Management</h4>
                    <ul>
                        <li>In the event of a collision, immediately engage hazard lights.</li>
                        <li>Capture video evidence of the scene and participants.</li>
                        <li>Do not engage in verbal altercations; record IDs and report via discord.</li>
                        <li>Contact Staff via Discord if required.</li>
                    </ul>
                </div>
            </div>

            <!-- LOA TAB -->
            <div id="tabDLoa" class="tab-content">
                <h2>Request Leave of Absence (LOA)</h2>
                <div class="card" style="margin-top: 20px; background: #161b22; border: 1px solid rgba(255,255,255,0.05);">
                    <p style="color: #8b9eb3; margin-bottom: 20px; font-size: 0.9rem;">Absences longer than 7 days require management approval.</p>
                    <div class="responsive-grid">
                        <div class="input-group"><label>Start Date</label><input type="date" id="loaStart"></div>
                        <div class="input-group"><label>End Date</label><input type="date" id="loaEnd"></div>
                    </div>
                    <div class="input-group">
                        <label>Reason for Leave</label>
                        <textarea id="loaReason" rows="3" placeholder="Brief explanation..."></textarea>
                    </div>
                    <button class="btn btn-primary" style="width:100%" onclick="submitLoa()">Submit Time-Off Request</button>
                </div>
                <h3 style="margin-top: 30px;">Your LOA History</h3>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead><tr><th>Dates</th><th>Reason</th><th>Status</th><th>Staff Comment</th></tr></thead>
                        <tbody id="driverLoaList"></tbody>
                    </table>
                </div>
            </div>

            <!-- HISTORY TAB -->
            <div id="tabDHistory" class="tab-content">
                <h2>Your Logged Deliveries</h2>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead><tr><th>Game</th><th>Route</th><th>Cargo</th><th>Time</th><th>Income</th></tr></thead>
                        <tbody id="driverHistoryList"></tbody>
                    </table>
                </div>
            </div>

            <!-- FEEDBACK TAB -->
            <div id="tabDFeedback" class="tab-content">
                <h2>Driver Feedback & Testimonials</h2>
                <div class="card" style="margin-top: 20px; background: #161b22; border: 1px solid rgba(255,255,255,0.05);">
                    <p style="margin-bottom: 20px; color: #8b9eb3;">Submit internal feedback or share a public testimonial for the home page.</p>
                    <div class="input-group">
                        <label>Topic</label>
                        <select id="feedTopic">
                            <option>Public Testimonial</option>
                            <option>General Suggestion</option>
                            <option>Company Complaint</option>
                            <option>Event Idea</option>
                            <option>Website Issue</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Message</label>
                        <textarea id="feedMsg" rows="5" placeholder="Type your feedback here..."></textarea>
                    </div>
                    <button class="btn btn-primary" style="width:100%" onclick="submitDriverFeedback()">Send Feedback</button>
                </div>
            </div>

            <!-- NEW TAB: REQUEST STREAMER -->
            <div id="tabDStreamer" class="tab-content">
                <h2>Request Official Streamer Status</h2>
                <div class="card" style="margin-top: 20px; background: #161b22; border: 1px solid rgba(255,255,255,0.05);">
                    <p style="color: #8b9eb3; margin-bottom: 20px;">
                        <strong>Requirements:</strong> You must hold the rank of <strong>Driver</strong> or higher to apply for the Official Streamer role.
                    </p>
                    <div class="input-group">
                        <label>Platform</label>
                        <select id="streamPlatform">
                            <option>Twitch</option>
                            <option>YouTube</option>
                            <option>Kick</option>
                            <option>Facebook Gaming</option>
                        </select>
                    </div>
                    <!-- NEW DISCORD USERNAME FIELD -->
                    <div class="input-group">
                        <label>Discord Username</label>
                        <input type="text" id="streamDiscord" placeholder="e.g. Trucker123">
                    </div>
                    <div class="input-group">
                        <label>Channel URL</label>
                        <input type="text" id="streamUrl" placeholder="https://twitch.tv/yourchannel">
                    </div>
                    <div class="input-group">
                        <label>Typical Schedule</label>
                        <input type="text" id="streamSchedule" placeholder="e.g. Mon/Wed/Fri 7PM UTC">
                    </div>
                    <div class="input-group">
                        <label>Why should we pick you?</label>
                        <textarea id="streamReason" rows="3" placeholder="Tell us about your content style..."></textarea>
                    </div>
                    <button class="btn btn-primary" style="width:100%" onclick="submitStreamerRequest()">Submit Application</button>
                </div>
            </div>

        </main>
    </div>
</div>

<!-- ADMIN DASHBOARD -->
<div id="adminPanelView" class="page-view" style="padding-top:0;">
    <div class="dashboard-layout">
        <aside class="sidebar">
            <h2 style="font-size: 1rem; color: #e74c3c; margin-bottom: 20px;">MANAGEMENT</h2>
            <button class="sidebar-btn active" id="btnADrivers" onclick="switchTab('admin', 'drivers')">Drivers</button>
            <button class="sidebar-btn" id="btnABulletins" onclick="switchTab('admin', 'bulletins')">Bulletins</button>
            <button class="sidebar-btn" id="btnAConvoys" onclick="switchTab('admin', 'convoys')">Convoys</button>
            <button class="sidebar-btn" id="btnAMedia" onclick="switchTab('admin', 'media')">Company Media</button>
            <button class="sidebar-btn" id="btnAReports" onclick="switchTab('admin', 'reports')">
                Reports <span class="sidebar-badge" id="reportBadge" style="display:none">0</span>
            </button>
            <button class="sidebar-btn" id="btnAFeedback" onclick="switchTab('admin', 'feedback')">Feedback</button>
            <button class="sidebar-btn" id="btnAStreamer" onclick="switchTab('admin', 'streamer')">Streamer Apps</button>
            <button class="sidebar-btn" id="btnAAccount" onclick="switchTab('admin', 'account')">
                Account <span class="sidebar-badge" id="forgotBadge" style="display:none">0</span>
            </button>
            <button class="sidebar-btn" id="btnALogs" onclick="switchTab('admin', 'logs')">Company Logs</button>
            <button class="sidebar-btn" id="btnALoa" onclick="switchTab('admin', 'loa')">LOA Requests</button>
            <button class="sidebar-btn" id="btnAPartners" onclick="switchTab('admin', 'partners')">Partners</button>
            <button class="sidebar-btn" id="btnABranding" onclick="switchTab('admin', 'branding')">Assets</button>
            <hr style="border:0; border-top:1px solid #30363d; margin: 20px 0;">
            <button class="sidebar-btn" style="color:#e74c3c" onclick="logout()">Logout</button>
        </aside>
        <main class="main-dash">
            <div class="welcome-banner" style="border-left-color: #e74c3c;">
                <h2 id="adminWelcomeMsg">Welcome, Staff</h2>
                <p style="color: #8b9eb3; font-size: 0.9rem;">Fleet Management & Logistics Control Panel</p>
            </div>

            <div id="tabADrivers" class="tab-content active">
                <h2>Personnel & Stats Management</h2>
                <div class="responsive-grid">
                    <div class="card" style="border: 1px solid #4a6a8c; background: #161b22;">
                        <h4 style="color:#4a6a8c; margin-bottom:10px;">Company Overview Stats</h4>
                        <div class="input-group">
                            <label>Active Drivers Count (Manual Offset)</label>
                            <input type="number" id="editActiveDrivers" value="0">
                        </div>
                        <div class="input-group">
                            <label>Jobs Completed Count (Manual Offset)</label>
                            <input type="number" id="editJobsCompleted" value="0">
                        </div>
                        <button class="btn btn-primary" onclick="updateManualStats()" style="width:100%">Save Public Stats</button>
                    </div>
                    <div class="card" style="background: #161b22; border: 1px solid rgba(255,255,255,0.05);">
                        <h4>Create New Driver Account</h4>
                        <div class="input-group">
                            <label>New Driver ID</label>
                            <input type="text" id="addDId" placeholder="New Driver ID">
                        </div>
                        <div class="input-group">
                            <label>Set Access Key</label>
                            <input type="text" id="addDPass" placeholder="Set Access Key">
                        </div>
                        <button class="btn btn-primary" onclick="adminAddDriver()" style="width:100%">Register Account</button>
                    </div>
                </div>
                <div style="margin-top: 30px;">
                    <h3>Active Personnel Management</h3>
                    <div id="adminDriverCards" style="margin-top: 15px;"></div>
                </div>
            </div>

            <!-- BULLETIN MANAGEMENT TAB (ENHANCED) -->
            <div id="tabABulletins" class="tab-content">
                <h2>Bulletin Board Management</h2>
                <div class="card" style="background: #161b22; border: 1px solid rgba(255,255,255,0.05);">
                    <h4>Post New Bulletin</h4>
                    
                    <div class="responsive-grid">
                        <!-- EDITOR SIDE -->
                        <div>
                            <!-- NEW CATEGORY DROPDOWN -->
                            <div class="input-group">
                                <label>Category</label>
                                <select id="bulType" onchange="updateBulletinPreview()">
                                    <option value="General">General</option>
                                    <option value="Important">Important</option>
                                    <option value="Update">Update</option>
                                </select>
                            </div>

                            <div class="input-group">
                                <label>Title</label>
                                <input type="text" id="bulTitle" placeholder="Bulletin Headline" onkeyup="updateBulletinPreview()">
                            </div>
                            
                            <label style="display:block; margin-bottom:5px; font-size:0.8rem; color:#8b9eb3;">Formatting Toolbar</label>
                            <div style="display:flex; gap:5px; margin-bottom:10px; flex-wrap:wrap;">
                                <button class="toolbar-btn" onclick="insertFormat('**', '**')">Bold</button>
                                <button class="toolbar-btn" onclick="insertFormat('*', '*')">Italic</button>
                                <button class="toolbar-btn" onclick="insertFormat('\n- ', '')">List Item</button>
                                <button class="toolbar-btn" onclick="insertFormat('‚ö†Ô∏è ', '')">Alert</button>
                                <button class="toolbar-btn" onclick="insertFormat('üéâ ', '')">Party</button>
                                <button class="toolbar-btn" onclick="insertFormat('üöõ ', '')">Truck</button>
                                <button class="toolbar-btn" onclick="insertFormat('‚ù§Ô∏è', '')">Heart</button>
                                <button class="toolbar-btn" onclick="insertFormat('======', '')">Line</button>
                            </div>

                            <div class="input-group">
                                <textarea id="bulBody" rows="12" placeholder="Type your message here... Use the toolbar for styling!" onkeyup="updateBulletinPreview()"></textarea>
                            </div>
                            <button id="btnPostBulletin" class="btn btn-primary" style="width:100%" onclick="addBulletin()">Publish to Fleet</button>
                        </div>

                        <!-- PREVIEW SIDE -->
                        <div>
                            <label style="color:#4a6a8c; font-weight:bold;">Live Preview</label>
                            <div style="margin-top: 5px; opacity: 0.8; font-size: 0.8rem; color:#8b9eb3;">This is exactly how drivers will see it.</div>
                            
                            <div id="bulPreviewContainer" style="margin-top:15px;">
                                <!-- Preview renders here -->
                                <div class="bulletin-card" id="prevCard">
                                    <div class="bulletin-title">
                                        <span style="color:#4a6a8c">üì¢</span> 
                                        <span id="prevTitle">Title Preview</span>
                                        <span id="prevBadge" class="bulletin-tag" style="background:#4a6a8c; color:white;">General</span>
                                    </div>
                                    <div class="bulletin-body" id="prevBody">Type in the editor to see preview...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <h3 style="margin-top:30px;">Active Bulletins</h3>
                <div id="adminBulletinList" style="margin-top:15px; display:grid; gap:15px;"></div>
            </div>

            <!-- CONVOY MANAGEMENT TAB -->
            <div id="tabAConvoys" class="tab-content">
                <h2>Convoy Management</h2>
                <div class="card" style="background: #161b22; border: 1px solid rgba(255,255,255,0.05);">
                    <h4>Schedule New Convoy</h4>
                    <div class="responsive-grid">
                        <div class="input-group"><label>Event Title</label><input type="text" id="convoyTitle" placeholder="e.g. Friday Night Haul"></div>
                        <div class="input-group"><label>Date & Time</label><input type="datetime-local" id="convoyDate"></div>
                    </div>
                    <div class="responsive-grid">
                        <div class="input-group">
                            <label>Game</label>
                            <select id="convoyGame">
                                <option>ETS2</option>
                                <option>ATS</option>
                            </select>
                        </div>
                        <div class="input-group"><label>Server</label><input type="text" id="convoyServer" placeholder="e.g. Sim 1"></div>
                    </div>
                    <div class="responsive-grid">
                        <div class="input-group"><label>Start City</label><input type="text" id="convoyStart" placeholder="e.g. Calais"></div>
                        <div class="input-group"><label>End City</label><input type="text" id="convoyEnd" placeholder="e.g. Duisburg"></div>
                    </div>
                    <div class="input-group"><label>Image URL (Optional)</label><input type="text" id="convoyImg" placeholder="https://..."></div>
                    <button id="btnSaveConvoy" class="btn btn-success" onclick="saveConvoy()" style="width:100%">Publish Event</button>
                </div>
                <h3 style="margin-top:30px;">Scheduled Convoys</h3>
                <div id="adminConvoyList" style="margin-top:15px; display:grid; gap:15px;"></div>
            </div>

            <!-- MEDIA MANAGEMENT TAB -->
            <div id="tabAMedia" class="tab-content">
                <h2>Company Media Gallery</h2>
                <div class="card" style="background: #161b22; border: 1px solid rgba(255,255,255,0.05);">
                    <h4>Upload New Photo</h4>
                    <p style="color: #8b9eb3; font-size: 0.85rem; margin-bottom: 15px;">Paste a direct link to an image (e.g. Imgur, Discord attachment).</p>
                    <div class="input-group"><label>Photo Title</label><input type="text" id="mediaTitle" placeholder="e.g. Fleet at sunset"></div>
                    <div class="input-group"><label>Image URL</label><input type="text" id="mediaUrl" placeholder="https://..."></div>
                    <button id="btnSaveMedia" class="btn btn-success" onclick="saveMedia()" style="width:100%">Add to Gallery</button>
                </div>
                <h3 style="margin-top:30px;">Active Gallery Images</h3>
                <div id="adminMediaList" style="margin-top:15px; display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:15px;"></div>
            </div>

            <div id="tabAReports" class="tab-content">
                <h2>Public Incident Reports</h2>
                <div id="adminReportList" style="display:grid; gap:15px;"></div>
            </div>

            <!-- FEEDBACK TAB (UPDATED WITH SEARCH) -->
            <div id="tabAFeedback" class="tab-content">
                <h2>Driver Feedback</h2>
                <div class="input-group" style="margin-bottom: 20px;">
                     <input type="text" id="adminFeedbackSearch" placeholder="Search by Driver, Topic or Message..." onkeyup="renderAdminFeedback()">
                </div>
                <div id="adminFeedbackList" style="display:grid; gap:15px;"></div>
            </div>

            <!-- STREAMER APPLICATIONS TAB -->
            <div id="tabAStreamer" class="tab-content">
                <h2>Official Streamer Applications</h2>
                <div id="adminStreamerList" style="display:grid; gap:15px; margin-top:20px;"></div>
            </div>

            <div id="tabAAccount" class="tab-content">
                <h2>Account Access Requests</h2>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead><tr><th>Driver ID</th><th>Discord User</th><th>Requested Pass</th><th>Action</th></tr></thead>
                        <tbody id="adminForgotList"></tbody>
                    </table>
                </div>
            </div>

            <!-- COMPANY LOGS TAB (UPDATED WITH SEARCH) -->
            <div id="tabALogs" class="tab-content">
                <h2>All Company Logs</h2>
                <div class="input-group" style="margin-bottom: 20px;">
                     <input type="text" id="adminLogSearch" placeholder="Search by Driver, Game, Cargo or City..." onkeyup="renderAdminLogs()">
                </div>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead><tr><th>Game</th><th>Driver</th><th>Source City</th><th>Destination</th><th>Cargo Type</th><th>Job Time</th><th>Income</th><th>Action</th></tr></thead>
                        <tbody id="adminGlobalList"></tbody>
                    </table>
                </div>
            </div>

            <div id="tabALoa" class="tab-content">
                <h2>LOA Queue</h2>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead><tr><th>Driver</th><th>Duration</th><th>Reason</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody id="adminLoaList"></tbody>
                    </table>
                </div>
            </div>

            <div id="tabAPartners" class="tab-content">
                <h2>Manage Affiliated Companies</h2>
                <div class="card" style="margin: 20px 0; background: #161b22; border: 1px solid rgba(255,255,255,0.05);">
                    <h4>Add New Partner</h4>
                    <div class="responsive-grid" style="margin-top:15px;">
                        <div class="input-group"><label>Partner Name</label><input type="text" id="partnerNameInput"></div>
                        <div class="input-group"><label>Description</label><input type="text" id="partnerRoleInput"></div>
                    </div>
                    <div class="input-group"><label>Image URL (Logo)</label><input type="text" id="partnerImgInput"></div>
                    <button class="btn btn-success" onclick="adminAddPartner()" style="width:100%">Add to Affiliates</button>
                </div>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead><tr><th>Logo</th><th>Name</th><th>Role</th><th>Actions</th></tr></thead>
                        <tbody id="adminPartnerList"></tbody>
                    </table>
                </div>
            </div>

            <div id="tabABranding" class="tab-content">
                <h2>Update Page Assets</h2>
                <div class="card" style="background: #161b22; border: 1px solid rgba(255,255,255,0.05);">
                    <div class="input-group"><label>Home Hero (URL)</label><input type="text" id="heroHomeUrl"></div>
                    <div class="input-group"><label>Company Hero (URL)</label><input type="text" id="heroCompanyUrl"></div>
                    <div class="input-group"><label>Partner Hero (URL)</label><input type="text" id="heroPartnerUrl"></div>
                    <div class="input-group"><label>Convoy Hero (URL)</label><input type="text" id="heroConvoyUrl"></div>
                    <div class="input-group"><label>Media Hero (URL)</label><input type="text" id="heroMediaUrl"></div>
                    <div class="input-group"><label>Report Hero (URL)</label><input type="text" id="heroReportUrl"></div>
                    <button class="btn btn-primary" onclick="updateHeroAssets()" style="width:100%; margin-top: 10px;">Update Backgrounds</button>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- JOIN OUR FLEET MODAL (FUTURISTIC) -->
<div id="recruitModal" class="recruit-modal">
    <div class="recruit-content">
        <h3 style="margin-bottom: 15px;">Join Our Fleet</h3>
        <img src="NSL_CLEAR_NO_TEXT.jpg" alt="NorthStar Logistics Recruitment" class="recruit-image">
        <div class="join-btn-container">
            <a href="https://hub.truckyapp.com/vtc/northstar-logistics" target="_blank" class="join-option">
                <strong>Trucky Hub</strong>
                <span>Apply Now</span>
            </a>
            <div class="join-option disabled">
                <strong>TruckersMP</strong>
                <span>Coming Soon</span>
            </div>
        </div>
        <a href="https://discord.gg/2GNHKbJeDM" target="_blank" class="join-option" style="margin-top: 15px; flex-direction: row; justify-content: center; gap: 10px;">
            <span style="background:#5865f2; padding: 2px 8px; border-radius: 4px;">Discord</span>
            <strong>Join our Community</strong>
        </a>
        <button onclick="closeRecruitModal()" class="btn btn-primary" style="width: 100%; margin-top: 20px; background: #333; border: 1px solid #555;">Close Terminal</button>
    </div>
</div>

<footer>&copy; 2025 NorthStar Logistics | Join our fleet</footer>

<script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, onSnapshot, query, where, orderBy, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    // --- FIREBASE CONFIGURATION ---
    // PASTE YOUR CONFIG HERE
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
        apiKey: "REPLACE_WITH_YOUR_API_KEY",
        authDomain: "REPLACE_WITH_YOUR_PROJECT_ID.firebaseapp.com",
        projectId: "REPLACE_WITH_YOUR_PROJECT_ID",
        storageBucket: "REPLACE_WITH_YOUR_PROJECT_ID.firebasestorage.app",
        messagingSenderId: "REPLACE_WITH_YOUR_SENDER_ID",
        appId: "REPLACE_WITH_YOUR_APP_ID"
    };

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'northstar-vtc-v1';
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- WEBHOOK CONFIGURATION ---
    const PROMOTION_WEBHOOK_URL = "https://discord.com/api/webhooks/1456358344003551466/uG2OBobnp148fHP6AVRv7aWo3min-WX_IdVUMWkWZoh5QIlAKECg-Ly5LHnnJyh6yNhl";
    const JOB_LOG_WEBHOOK_URL = "https://discord.com/api/webhooks/1446235537609330831/a5Mmj9RMi2wwixX3AJ4qvrZ_uPbm4ID1XwbLlfK8NWu3upbtDBTUU9zmHZ_d9z6zLKiO";
    const FEEDBACK_WEBHOOK_URL = "https://discord.com/api/webhooks/1456724860100415538/bGN36pUEgd38r_zyvph0-Moc-Q9AmOWue3Fn56R01bQRGlzLGDyyLFpdDflzyhUboBcB";
    const REPORT_WEBHOOK_URL = "https://discord.com/api/webhooks/1456727093466501367/NphNTK9aJCeC_dI6mJcX2eQHV3ioVcsxO6XMd0yJOusUd56AsldhujdDDhfIUDVzQbGh";
    const STREAMER_WEBHOOK_URL = "https://discord.com/api/webhooks/1457053081102712863/FGDmkvmUbzufGHd_ofgu_Es35WyPMsEhmRkyIar1O7e-bm2o4nc5m8V8fV1LAX70Wevo"; 

    // --- GLOBAL STATE ---
    // This now syncs with Firestore
    const state = {
        drivers: [], // From Firestore
        logs: [],
        loas: [], 
        forgotRequests: [],
        reports: [],
        feedbacks: [],
        streamerRequests: [],
        convoys: [],
        media: [],
        bulletins: [],
        ranks: ["Trainee", "Junior Driver", "Driver", "Pro Driver", "God Driver", "God Hauler", "Legendary Hauler"],
        manualStats: { drivers: 0, jobs: 0 },
        assets: {
            homeHero: 'https://images.unsplash.com/photo-1519003722824-194d4455a60c?auto=format&fit=crop&q=80&w=2000',
            companyHero: 'https://images.unsplash.com/photo-1586528116311-ad8dd3c8310d?auto=format&fit=crop&q=80&w=2000',
            partnerHero: 'https://images.unsplash.com/photo-1521737711867-e3b97375f902?auto=format&fit=crop&q=80&w=2000',
            reportHero: 'https://images.unsplash.com/photo-1454165833767-027ffea9e778?auto=format&fit=crop&q=80&w=2000',
            convoyHero: 'https://images.unsplash.com/photo-1605218427306-0396d812068d?auto=format&fit=crop&q=80&w=2000',
            mediaHero: 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&q=80&w=2000'
        },
        partners: [] 
    };

    let currentUser = null; // Contains { id, email, rank, isAdmin, uid }
    let authMode = 'driver'; // 'driver' or 'admin'
    let editingBulletinId = null;
    let editingConvoyId = null;
    let editingMediaId = null;

    // Helper for collection refs
    const getCol = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);

    // --- INITIALIZATION ---
    window.onload = () => {
        applyHeroBackgrounds(); 
        
        // Listen for Public Data (Runs for everyone)
        subscribeToPublicData();

        // Auth Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in. Fetch their profile.
                const profileRef = doc(db, 'artifacts', appId, 'public', 'data', 'drivers', user.uid);
                const profileSnap = await getDoc(profileRef);
                
                if (profileSnap.exists()) {
                    const data = profileSnap.data();
                    currentUser = { 
                        uid: user.uid, 
                        email: user.email, 
                        id: data.driverId || user.email.split('@')[0], 
                        rank: data.rank || "Trainee", 
                        isAdmin: data.isAdmin || false 
                    };
                    
                    if(currentUser.isAdmin) {
                        showView('adminPanel');
                    } else {
                        showView('driverPanel');
                    }
                } else {
                    // Profile missing? create default or show error
                    console.log("No profile found for user.");
                    // Fallback for new users who signed up
                    currentUser = { uid: user.uid, email: user.email, id: "New Driver", rank: "Trainee", isAdmin: false };
                    showView('driverPanel');
                }
            } else {
                currentUser = null;
                showView('home');
            }
        });
    };

    function subscribeToPublicData() {
        // Bulletins
        onSnapshot(getCol('bulletins'), (snap) => {
            state.bulletins = snap.docs.map(d => ({id: d.id, ...d.data()}));
            if(document.getElementById('driverBulletinBoard')) renderDriverBulletins();
            if(document.getElementById('adminBulletinList')) renderAdminBulletins();
        });

        // Convoys
        onSnapshot(getCol('convoys'), (snap) => {
            state.convoys = snap.docs.map(d => ({id: d.id, ...d.data()}));
            if(document.getElementById('publicConvoyGrid')) renderPublicConvoys();
            if(document.getElementById('adminConvoyList')) renderAdminConvoys();
        });

        // Media
        onSnapshot(getCol('media'), (snap) => {
            state.media = snap.docs.map(d => ({id: d.id, ...d.data()}));
            if(document.getElementById('publicMediaGrid')) renderPublicMedia();
            if(document.getElementById('adminMediaList')) renderAdminMedia();
        });
        
        // Logs
        onSnapshot(getCol('logs'), (snap) => {
            state.logs = snap.docs.map(d => ({id: d.id, ...d.data()}));
            updatePublicCounters();
            if(document.getElementById('driverHistoryList')) renderDriverHistory();
            if(document.getElementById('adminGlobalList')) renderAdminLogs();
        });

        // Drivers (For stats and admin list)
        onSnapshot(getCol('drivers'), (snap) => {
            state.drivers = snap.docs.map(d => ({id: d.id, ...d.data()}));
            updatePublicCounters();
            if(document.getElementById('adminDriverCards')) renderAdminDrivers();
        });

        // Partners
        onSnapshot(getCol('partners'), (snap) => {
            state.partners = snap.docs.map(d => ({id: d.id, ...d.data()}));
            if(document.getElementById('publicPartnerGrid')) renderPublicPartners();
            if(document.getElementById('adminPartnerList')) renderAdminPartners();
        });

        // Feedbacks
        onSnapshot(getCol('feedbacks'), (snap) => {
            state.feedbacks = snap.docs.map(d => ({id: d.id, ...d.data()}));
            renderPublicTestimonials(); // only public ones show
            if(document.getElementById('adminFeedbackList')) renderAdminFeedback();
        });

        // Reports (Admin Only usually, but simplified for this demo)
        onSnapshot(getCol('reports'), (snap) => {
            state.reports = snap.docs.map(d => ({id: d.id, ...d.data()}));
            if(document.getElementById('adminReportList')) renderAdminReports();
        });

        // LOAs
        onSnapshot(getCol('loas'), (snap) => {
            state.loas = snap.docs.map(d => ({id: d.id, ...d.data()}));
            if(document.getElementById('driverLoaList')) renderDriverLoa();
            if(document.getElementById('adminLoaList')) renderAdminLoa();
        });

        // Streamer Requests
        onSnapshot(getCol('streamerRequests'), (snap) => {
            state.streamerRequests = snap.docs.map(d => ({id: d.id, ...d.data()}));
            if(document.getElementById('adminStreamerList')) renderAdminStreamerRequests();
        });

        // Stats (Manual)
        onSnapshot(getCol('stats'), (snap) => {
            if(!snap.empty) {
                state.manualStats = snap.docs[0].data();
            }
            updatePublicCounters();
        });
        
        // Assets
        onSnapshot(getCol('assets'), (snap) => {
            if(!snap.empty) {
                state.assets = snap.docs[0].data();
                applyHeroBackgrounds();
            }
        });
    }

    // --- AUTH FUNCTIONS ---
    window.handleLogin = async (event) => {
        event.preventDefault();
        const email = document.getElementById('emailInput').value;
        const pass = document.getElementById('passInput').value;
        try {
            await signInWithEmailAndPassword(auth, email, pass);
            // onAuthStateChanged handles redirection
        } catch (error) {
            openModal('Login Failed', error.message);
        }
    };

    window.handleSignUp = async () => {
        const email = document.getElementById('emailInput').value;
        const pass = document.getElementById('passInput').value;
        if(!email || !pass) return openModal('Error', 'Enter email and password to sign up.');
        
        try {
            const userCred = await createUserWithEmailAndPassword(auth, email, pass);
            // Create initial profile
            const uid = userCred.user.uid;
            const driverId = "Driver_" + Math.floor(Math.random()*1000);
            
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'drivers', uid), {
                email: email,
                driverId: driverId,
                rank: "Trainee",
                isAdmin: false, // Default
                createdAt: new Date().toISOString()
            });
            openModal('Success', `Account created! Your Driver ID is ${driverId}.`);
        } catch (error) {
            openModal('Sign Up Failed', error.message);
        }
    };

    window.logout = () => {
        signOut(auth);
    };

    // --- CRUD WRAPPERS ---
    async function addData(colName, data) {
        await addDoc(getCol(colName), data);
    }
    
    async function updateData(colName, id, data) {
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', colName, id), data);
    }

    async function deleteData(colName, id) {
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', colName, id));
    }

    // --- UI FUNCTIONS ---
    window.showView = (viewId) => {
        document.querySelectorAll('.page-view').forEach(v => v.classList.remove('active'));
        const target = document.getElementById(viewId + 'View');
        if (target) target.classList.add('active');

        document.getElementById('mainHeader').style.display = viewId.includes('Panel') ? 'none' : 'flex';
        
        if (viewId === 'home') renderPublicTestimonials(); 
        if (viewId === 'partnership') renderPublicPartners();
        if (viewId === 'company') updatePublicCounters();
        if (viewId === 'convoy') renderPublicConvoys(); 
        if (viewId === 'media') renderPublicMedia(); 
        
        if (viewId === 'adminPanel') {
            document.getElementById('adminWelcomeMsg').innerText = `Welcome, ${currentUser.id}`;
            // Render functions are handled by snapshot listeners now
            document.getElementById('editActiveDrivers').value = state.manualStats.drivers;
            document.getElementById('editJobsCompleted').value = state.manualStats.jobs;
            document.getElementById('heroHomeUrl').value = state.assets.homeHero;
            document.getElementById('heroCompanyUrl').value = state.assets.companyHero;
            document.getElementById('heroPartnerUrl').value = state.assets.partnerHero;
            document.getElementById('heroReportUrl').value = state.assets.reportHero;
            document.getElementById('heroConvoyUrl').value = state.assets.convoyHero || "";
            document.getElementById('heroMediaUrl').value = state.assets.mediaHero || "";
            
            updateBulletinPreview();
        }
        
        if (viewId === 'driverPanel') {
            checkLNotifications();
            document.getElementById('driverWelcomeMsg').innerText = `Welcome, ${currentUser.id}`;
            document.getElementById('sidebarDriverRank').innerText = `Rank: ${currentUser.rank || 'Trainee'}`;
            
            // CHECK RANK FOR STREAMER TAB VISIBILITY
            const rankIndex = state.ranks.indexOf(currentUser.rank || "Trainee");
            const minRankIndex = state.ranks.indexOf("Driver");
            const btnStreamer = document.getElementById('btnDStreamer');
            
            if (rankIndex >= minRankIndex && minRankIndex !== -1) {
                btnStreamer.style.display = 'flex';
            } else {
                btnStreamer.style.display = 'none';
            }

            switchTab('driver', 'dash');
        }
        
        window.scrollTo(0, 0);
    };

    window.switchTab = (panel, tab) => {
        const prefix = panel === 'driver' ? 'D' : 'A';
        document.querySelectorAll(`.sidebar-btn`).forEach(b => b.classList.remove('active'));
        document.querySelectorAll(`.tab-content`).forEach(t => t.classList.remove('active'));
        
        const btnId = `btn${prefix}${tab.charAt(0).toUpperCase() + tab.slice(1)}`;
        const btnElem = document.getElementById(btnId);
        if(btnElem) btnElem.classList.add('active');

        const tabId = `tab${prefix}${tab.charAt(0).toUpperCase() + tab.slice(1)}`;
        const tabElem = document.getElementById(tabId);
        if(tabElem) tabElem.classList.add('active');
        
        if (tab === 'dash' && panel === 'driver') renderRankProgress(); 
        if (tab === 'history') renderDriverHistory();
        if (tab === 'loa' && panel === 'driver') renderDriverLoa();
        if (tab === 'loa' && panel === 'admin') renderAdminLoa();
        if (tab === 'logs') renderAdminLogs();
        if (tab === 'drivers') renderAdminDrivers();
        if (tab === 'bulletins') {
            renderAdminBulletins();
            updateBulletinPreview();
        } 
    };

    window.setAuthMode = (mode) => {
        authMode = mode;
        const isAdm = mode === 'admin';
        document.getElementById('modeAdmin').style.color = isAdm ? "#4a6a8c" : "#8b9eb3";
        document.getElementById('modeAdmin').style.borderBottom = isAdm ? "2px solid #4a6a8c" : "none";
        document.getElementById('modeDriver').style.color = isAdm ? "#8b9eb3" : "#4a6a8c";
        document.getElementById('modeDriver').style.borderBottom = isAdm ? "none" : "2px solid #4a6a8c";
    };

    // --- BULLETIN SYSTEM ---
    window.parseBulletin = (text) => {
        if (!text) return "";
        let html = text
            .replace(/\n/g, '<br>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/======/g, '<hr class="bulletin-divider">')
            .replace(/- (.*?)(<br>|$)/g, '<li>$1</li>');
        
        if (html.includes('<li>')) {
            html = html.replace(/<li>.*<\/li>/s, '<ul>$&</ul>');
        }
        return html;
    };

    window.insertFormat = (prefix, suffix) => {
        const textarea = document.getElementById('bulBody');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const text = textarea.value;
        const before = text.substring(0, start);
        const selected = text.substring(start, end);
        const after = text.substring(end);
        
        textarea.value = before + prefix + selected + suffix + after;
        textarea.focus();
        textarea.selectionStart = start + prefix.length;
        textarea.selectionEnd = end + prefix.length;
        updateBulletinPreview();
    };

    window.updateBulletinPreview = () => {
        const title = document.getElementById('bulTitle').value || "Bulletin Title";
        const body = document.getElementById('bulBody').value || "Content preview...";
        const type = document.getElementById('bulType').value;
        
        const colors = { 'General': '#4a6a8c', 'Important': '#e74c3c', 'Update': '#27ae60' };
        const color = colors[type] || '#4a6a8c';

        const card = document.getElementById('prevCard');
        const badge = document.getElementById('prevBadge');
        
        if(card) card.style.borderLeftColor = color;
        if(badge) {
            badge.style.backgroundColor = color;
            badge.innerText = type;
        }

        if(document.getElementById('prevTitle')) document.getElementById('prevTitle').innerText = title;
        if(document.getElementById('prevBody')) document.getElementById('prevBody').innerHTML = parseBulletin(body);
    };

    // --- RENDERERS ---
    window.renderDriverBulletins = () => {
        const board = document.getElementById('driverBulletinBoard');
        if(!board) return;
        if(state.bulletins.length === 0) {
            board.innerHTML = "<p style='color:#8b9eb3'>No news at this time.</p>";
            return;
        }
        
        const colors = { 'General': '#4a6a8c', 'Important': '#e74c3c', 'Update': '#27ae60' };

        board.innerHTML = state.bulletins.map(b => {
            const color = colors[b.type] || '#4a6a8c';
            return `
            <div class="bulletin-card" style="border-left-color: ${color}">
                <div class="bulletin-title">
                    <span style="color:${color}">üì¢</span> ${b.title}
                    <span class="bulletin-tag" style="background:${color}; color:white;">${b.type}</span>
                </div>
                <div class="bulletin-body">${parseBulletin(b.body)}</div>
            </div>
        `}).join('');
    };

    window.renderAdminBulletins = () => {
        const list = document.getElementById('adminBulletinList');
        if(!list) return;
        list.innerHTML = state.bulletins.map(b => `
            <div class="card" style="padding:15px; display:flex; justify-content:space-between; align-items:center;">
                <div style="flex:1;">
                    <strong>${b.title}</strong> <span style="font-size:0.7rem; color:#8b9eb3">[${b.type}]</span>
                    <div style="font-size:0.8rem; color:#8b9eb3; max-height:40px; overflow:hidden; text-overflow:ellipsis;">${b.body}</div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary btn-sm" onclick="editBulletin('${b.id}')">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteBulletin('${b.id}')">Delete</button>
                </div>
            </div>
        `).join('');
    };

    window.addBulletin = async () => {
        const t = document.getElementById('bulTitle').value;
        const b = document.getElementById('bulBody').value;
        const type = document.getElementById('bulType').value;

        if (!t || !b) return openModal("Error", "Please fill in title and body.");

        if (editingBulletinId) {
            await updateData('bulletins', editingBulletinId, { title: t, body: b, type: type });
            editingBulletinId = null;
            document.getElementById('btnPostBulletin').innerText = "Publish to Fleet";
            document.getElementById('btnPostBulletin').className = "btn btn-primary";
            openModal("Success", "Bulletin updated.");
        } else {
            await addData('bulletins', { title: t, body: b, type: type, date: new Date().toISOString() });
            openModal("Success", "Bulletin posted.");
        }

        document.getElementById('bulTitle').value = "";
        document.getElementById('bulBody').value = "";
    };

    window.editBulletin = (id) => {
        const bul = state.bulletins.find(b => b.id === id);
        if (!bul) return;

        document.getElementById('bulTitle').value = bul.title;
        document.getElementById('bulBody').value = bul.body;
        document.getElementById('bulType').value = bul.type || "General";
        editingBulletinId = id;

        updateBulletinPreview();

        const btn = document.getElementById('btnPostBulletin');
        btn.innerText = "Update Bulletin";
        btn.className = "btn btn-success";
        document.getElementById('tabABulletins').scrollIntoView({behavior: 'smooth'});
    };

    window.deleteBulletin = async (id) => {
        if(confirm('Delete this bulletin?')) {
            await deleteData('bulletins', id);
        }
    };

    // --- CONVOYS ---
    window.renderPublicConvoys = () => {
        const grid = document.getElementById('publicConvoyGrid');
        if(!grid) return;
        if(state.convoys.length === 0) {
            grid.innerHTML = "<p style='text-align:center; color:#8b9eb3; grid-column:1/-1'>No upcoming convoys scheduled.</p>";
            return;
        }

        grid.innerHTML = state.convoys.map(c => {
            const d = new Date(c.date);
            const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            const img = c.img || "https://images.unsplash.com/photo-1605218427306-0396d812068d?auto=format&fit=crop&q=80&w=1000"; 
            const badgeColor = c.game === 'ATS' ? '#d35400' : '#2980b9'; 
            return `
            <div class="convoy-card">
                <div class="convoy-header" style="background-image: url('${img}')">
                    <div class="convoy-date-box">
                        <div class="convoy-day">${d.getDate()}</div>
                        <div class="convoy-month">${months[d.getMonth()]}</div>
                    </div>
                    <div class="convoy-game-badge" style="background: ${badgeColor};">${c.game}</div>
                </div>
                <div class="convoy-body">
                    <div class="convoy-title">${c.title}</div>
                    <div class="convoy-meta">
                        <span>üïí ${d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        <span>üñ•Ô∏è ${c.server}</span>
                    </div>
                    <div class="convoy-route-vis">
                        <span>${c.start}</span>
                        <span class="route-arrow">‚ûî</span>
                        <span>${c.end}</span>
                    </div>
                    <button class="btn btn-primary btn-sm" style="width:100%; margin-top:auto;" onclick="openModal('Join Convoy', 'Please join our Discord if you wish to participate in this convoy! ')">Attend Event</button>
                </div>
            </div>`;
        }).join('');
    };

    window.saveConvoy = async () => {
        const title = document.getElementById('convoyTitle').value;
        const date = document.getElementById('convoyDate').value;
        const game = document.getElementById('convoyGame').value; 
        const start = document.getElementById('convoyStart').value;
        const end = document.getElementById('convoyEnd').value;
        const server = document.getElementById('convoyServer').value;
        const img = document.getElementById('convoyImg').value;

        if(!title || !date) return openModal('Error', 'Missing required fields.');

        const data = { title, date, game, start, end, server, img };

        if(editingConvoyId) {
            await updateData('convoys', editingConvoyId, data);
            editingConvoyId = null;
            document.getElementById('btnSaveConvoy').innerText = "Publish Event";
            document.getElementById('btnSaveConvoy').className = "btn btn-success";
        } else {
            await addData('convoys', data);
        }

        document.getElementById('convoyTitle').value = "";
        document.getElementById('convoyDate').value = "";
        openModal('Success', 'Convoy updated successfully.');
    };

    window.renderAdminConvoys = () => {
        const list = document.getElementById('adminConvoyList');
        if(!list) return;
        list.innerHTML = state.convoys.map(c => `
            <div class="card" style="padding:15px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <strong>${c.title}</strong>
                    <div style="font-size:0.8rem; color:#8b9eb3;">${c.date}</div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary btn-sm" onclick="editConvoy('${c.id}')">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteConvoy('${c.id}')">Delete</button>
                </div>
            </div>
        `).join('');
    };

    window.editConvoy = (id) => {
        const c = state.convoys.find(x => x.id === id);
        if(!c) return;
        document.getElementById('convoyTitle').value = c.title;
        document.getElementById('convoyDate').value = c.date;
        document.getElementById('convoyGame').value = c.game;
        document.getElementById('convoyStart').value = c.start;
        document.getElementById('convoyEnd').value = c.end;
        document.getElementById('convoyServer').value = c.server;
        document.getElementById('convoyImg').value = c.img;
        editingConvoyId = id;
        document.getElementById('btnSaveConvoy').innerText = "Update Event";
    };

    window.deleteConvoy = async (id) => {
        if(confirm('Delete convoy?')) await deleteData('convoys', id);
    };

    // --- LOGS & STATS ---
    window.submitJob = async () => {
        if(!currentUser) return;
        const game = document.getElementById('jobGame').value;
        const s = document.getElementById('jobStart').value;
        const e = document.getElementById('jobEnd').value;
        const c = document.getElementById('jobCargo').value;
        const t = document.getElementById('jobTime').value;
        const inc = document.getElementById('jobIncome').value;

        if (!s || !e) return openModal('Error', 'Please fill in details.');
        
        const newJob = { 
            driver: currentUser.id, 
            driverUid: currentUser.uid,
            game: game,
            start: s, 
            end: e, 
            cargo: c, 
            time: t || 0,
            income: inc,
            date: new Date().toISOString()
        };

        await addData('logs', newJob);
        
        // Webhook
        fetch(JOB_LOG_WEBHOOK_URL, {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                content: null,
                embeds: [{
                    title: "üöõ New Job Logged",
                    description: `<:Driver:1455298757204643900> **Driver:** ${newJob.driver}\n**Game:** ${newJob.game}\n**Route:** ${newJob.start} -> ${newJob.end}\n**Cargo:** ${newJob.cargo}`,
                    color: 3447003
                }]
            })
        }).catch(e=>{});

        document.getElementById('jobStart').value = "";
        document.getElementById('jobEnd').value = "";
        
        // Promotion Logic Check
        checkPromotion();
        openModal('Success', 'Job Logged.');
    };

    window.checkPromotion = async () => {
        if(!currentUser) return;
        // Count jobs for this user
        const myJobs = state.logs.filter(l => l.driverUid === currentUser.uid).length;
        const currentRank = currentUser.rank;
        const ranks = state.ranks;
        const thresholds = [0, 4, 15, 30, 50, 100, 240];
        
        let calcRank = "Trainee";
        for (let i = thresholds.length - 1; i >= 0; i--) {
            if (myJobs >= thresholds[i]) {
                calcRank = ranks[i];
                break;
            }
        }

        if (calcRank !== currentRank) {
            // Update Firestore Profile
            await updateData('drivers', currentUser.uid, { rank: calcRank });
            currentUser.rank = calcRank; // Update local state
            document.getElementById('sidebarDriverRank').innerText = `Rank: ${calcRank}`;
            
            // Webhook
            fetch(PROMOTION_WEBHOOK_URL, {
                method: "POST", headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    embeds: [{ title: "Promotion!", description: `${currentUser.id} promoted to ${calcRank}`, color: 5814783 }]
                })
            }).catch(e=>{});
            
            openModal('Promotion!', `You have been promoted to ${calcRank}!`);
        }
    };

    window.renderDriverHistory = () => {
        const body = document.getElementById('driverHistoryList');
        if(!body) return;
        const myLogs = state.logs.filter(l => l.driverUid === currentUser.uid);
        body.innerHTML = myLogs.length ? "" : "<tr><td colspan='4'>No jobs found.</td></tr>";
        myLogs.forEach(l => { 
            body.innerHTML += `<tr><td>${l.game}</td><td>${l.start} ‚ûî ${l.end}</td><td>${l.cargo}</td><td>${l.time}h</td><td>$${l.income}</td></tr>`; 
        });
    };

    window.renderAdminLogs = () => {
        const query = document.getElementById('adminLogSearch')?.value.toLowerCase() || "";
        const body = document.getElementById('adminGlobalList');
        if(!body) return;
        
        const filtered = state.logs.filter(l => 
            (l.driver || "").toLowerCase().includes(query) ||
            (l.start || "").toLowerCase().includes(query)
        );

        if (filtered.length === 0) {
             body.innerHTML = "<tr><td colspan='8' style='text-align:center'>No logs match.</td></tr>";
             return;
        }

        body.innerHTML = filtered.map(l => `<tr><td>${l.game}</td><td>${l.driver}</td><td>${l.start}</td><td>${l.end}</td><td>${l.cargo}</td><td>${l.time}</td><td>${l.income}</td><td><button onclick="deleteData('logs', '${l.id}')" class="btn btn-danger btn-sm">X</button></td></tr>`).join('');
    };

    // --- OTHER UI UTILS ---
    window.openModal = (t, x) => { 
        document.getElementById('modalTitle').innerText = t; 
        document.getElementById('modalText').innerText = x; 
        document.getElementById('generalModal').style.display = 'flex'; 
    };
    window.closeModal = () => { document.getElementById('generalModal').style.display = 'none'; };
    window.openForgotModal = () => { document.getElementById('forgotPasswordModal').style.display = 'flex'; };
    window.closeForgotModal = () => { document.getElementById('forgotPasswordModal').style.display = 'none'; };
    window.openRecruitModal = () => { document.getElementById('recruitModal').style.display = 'flex'; };
    window.closeRecruitModal = () => { document.getElementById('recruitModal').style.display = 'none'; };
    window.showJoinInstructions = () => { openRecruitModal(); };

    window.renderRankProgress = () => {
        if(!currentUser) return;
        const myJobs = state.logs.filter(l => l.driverUid === currentUser.uid).length;
        const currentRankIdx = state.ranks.indexOf(currentUser.rank || "Trainee");
        const nextRank = state.ranks[currentRankIdx + 1];
        const thresholds = [0, 4, 15, 30, 50, 100, 240];
        
        const bar = document.getElementById('rankProgressBar');
        const text = document.getElementById('rankProgressText');
        const nextName = document.getElementById('nextRankName');
        
        if (!nextRank) {
            bar.style.width = '100%';
            text.innerText = `${myJobs} Jobs`;
            nextName.innerText = "Max Rank Achieved";
        } else {
            const prevThreshold = thresholds[currentRankIdx] || 0;
            const nextThreshold = thresholds[currentRankIdx + 1] || (prevThreshold + 10);
            
            let percent = 0;
            if (myJobs >= nextThreshold) {
                percent = 100;
            } else {
                const range = nextThreshold - prevThreshold;
                const progress = Math.max(0, myJobs - prevThreshold); 
                percent = Math.min(100, (progress / range) * 100);
            }

            bar.style.width = `${percent}%`;
            text.innerText = `${myJobs} / ${nextThreshold} Jobs`;
            nextName.innerText = nextRank;
        }
    };

    window.updatePublicCounters = () => {
        const liveDrivers = state.drivers.length;
        const liveJobs = state.logs.length;
        const manualDrivers = parseInt(state.manualStats.drivers || 0);
        const manualJobs = parseInt(state.manualStats.jobs || 0);

        document.getElementById('dispDrivers').innerText = manualDrivers + liveDrivers;
        document.getElementById('dispJobs').innerText = manualJobs + liveJobs;
    };

    window.adminAddDriver = async () => {
        // Now just creates a profile shell. User must sign up with email.
        const id = document.getElementById('addDId').value;
        const email = id + "@northstar.vtc"; // Fake email generation for shell
        // Ideally, admins don't "create" users in firebase easily without cloud functions. 
        // This function will now just be a "Pre-approve" or "Manual Profile Entry".
        // For simplicity, we skip this or just alert:
        alert("In Firebase mode, users must Sign Up themselves via the Login screen.");
    };

    window.updateManualStats = async () => {
        const d = document.getElementById('editActiveDrivers').value;
        const j = document.getElementById('editJobsCompleted').value;
        // Upsert stats doc
        // We need a specific ID for the stats doc to update it easily, let's say 'main'
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'main'), { drivers: d, jobs: j });
        openModal('Success', 'Stats updated');
    };

    window.renderAdminDrivers = () => {
        const container = document.getElementById('adminDriverCards');
        container.innerHTML = state.drivers.length ? "" : "<p style='color:#8b9eb3'>No drivers.</p>";
        state.drivers.forEach(d => {
            container.innerHTML += `
                <div class="card" style="margin-bottom:10px; padding:15px;">
                    <strong>${d.driverId}</strong> (${d.email}) - ${d.rank} 
                    ${d.isAdmin ? '<span class="badge badge-approved">Admin</span>' : ''}
                </div>`;
        });
    };

    // Initialize View
    showView('home');

</script>
</body>
</html>
